document.addEventListener("DOMContentLoaded",(()=>{const e=document.getElementById("categorias-btn"),t=document.getElementById("categorias-modal"),o=document.querySelector(".close");if(e&&t&&o){function n(){document.body.style.overflow=""}t.classList.remove("show"),e.addEventListener("click",(()=>{t.classList.add("show"),document.body.style.overflow="hidden"})),o.addEventListener("click",(()=>{t.classList.remove("show"),n()})),window.addEventListener("click",(e=>{e.target===t&&(t.classList.remove("show"),n())}))}const a=document.querySelector(".dropdown");if(a){a.querySelector(".dropdown__boton").addEventListener("click",(e=>{e.stopPropagation(),a.classList.toggle("mostrar")})),window.addEventListener("click",(e=>{a.contains(e.target)||a.classList.remove("mostrar")}))}const r=document.querySelectorAll(".contador");if(r.length>0){const y=e=>{const t=parseInt(e.dataset.target,10);let o=0;const n=t/31.25,a=()=>{o+=n,o>=t?e.innerText=`+${t}`:(e.innerText=`+${Math.floor(o)}`,requestAnimationFrame(a))};a()},h=new IntersectionObserver((e=>{e.forEach((e=>{e.isIntersecting&&(e.target.classList.remove("animado"),e.target.innerText="+0",y(e.target))}))}),{threshold:.3});r.forEach((e=>h.observe(e))),window.addEventListener("load",(()=>{r.forEach((e=>{e.classList.contains("animado")||y(e)}))}))}const i=document.querySelector(".dashboard__mobile-menu"),s=document.querySelector(".dashboard__sidebar");i&&s&&(i.addEventListener("click",(function(){s.classList.toggle("sidebar--mostrar")})),document.body.addEventListener("click",(function(e){s.contains(e.target)||i.contains(e.target)||s.classList.remove("sidebar--mostrar")}))),document.querySelectorAll(".favorito-btn").forEach((e=>{e.addEventListener("click",(async t=>{if(t.preventDefault(),this.disabled)return;const o=e.dataset.productoId,n=e.querySelector("i");try{const e=await fetch("/favoritos/toggle",{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},body:`productoId=${encodeURIComponent(o)}`}),t=await e.json();if(!e.ok)throw new Error(t.error||"Error en la solicitud");n.classList.toggle("fa-regular"),n.classList.toggle("fa-solid");const a=document.querySelector(".alert-notification");a&&a.remove();const r="added"===t.action?'<i class="fas fa-check-circle"></i> Agregado a favoritos':'<i class="fas fa-trash-alt"></i> Eliminado de favoritos',i=document.createElement("div");i.className="alert-notification",i.innerHTML=r,i.style.backgroundColor="added"===t.action?"#4CAF50":"#f44336",document.body.appendChild(i),setTimeout((()=>{i.style.opacity="0",setTimeout((()=>i.remove()),300)}),2500)}catch(e){console.error("Error:",e),alert(e.message)}}))})),document.body.addEventListener("click",(async function(e){if(e.target.closest(".no-interesa-btn")){const t=e.target.closest(".no-interesa-btn"),o=t.dataset.productoId;try{const e=await fetch("/api/productos/no-interesa",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({productoId:o})}),n=await e.json();if(n.success){const e=t.closest('.producto[data-producto-card-id="'+o+'"]');e&&(e.style.transition="opacity 0.5s ease",e.style.opacity="0",setTimeout((()=>e.remove()),500));const n=document.createElement("div");n.className="alert-notification",n.innerHTML='<i class="fas fa-check-circle"></i> No volveremos a mostrarte este producto.',n.style.backgroundColor="#2196F3",document.body.appendChild(n),setTimeout((()=>{n.style.opacity="0",setTimeout((()=>n.remove()),300)}),3e3)}else alert("Error: "+n.error)}catch(e){console.error("Error:",e),alert("No se pudo completar la acción.")}}})),document.addEventListener("click",(async e=>{if(e.target.classList.contains("btn-eliminar-preferencia")){const t=e.target,o=t.closest(".item-no-interesado"),n=o.dataset.productoId;if(t.disabled)return;t.disabled=!0,t.textContent="Eliminando...";try{const e=await fetch("/perfil/eliminar-no-interesa",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({productoId:n})}),t=await e.json();if(!e.ok||!t.success)throw new Error(t.error||"Error desconocido del servidor.");o.style.transition="opacity 0.3s ease",o.style.opacity="0",setTimeout((()=>o.remove()),300)}catch(e){console.error("Error al procesar la solicitud:",e),alert(e.message),t.disabled=!1,t.textContent="Eliminar"}}}));const c=document.getElementById("modal-reporte-valoracion");if(!c)return;const l=document.getElementById("form-reporte-valoracion"),d=c.querySelector(".modal-reporte__cerrar"),u=document.getElementById("reporte-valoracion-id");document.body.addEventListener("click",(function(e){if(e.target.closest(".reportar-btn")){const t=e.target.closest(".reportar-btn").dataset.valoracionId;u.value=t,c.style.display="flex"}})),d.onclick=()=>{c.style.display="none"},window.onclick=e=>{e.target===c&&(c.style.display="none")},l.addEventListener("submit",(async function(e){e.preventDefault();const t=new FormData(this),o=Object.fromEntries(t.entries());try{const e=await fetch("/valoraciones/reportar",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(o)}),t=await e.json();alert(t.message||t.error),e.ok&&(c.style.display="none",l.reset())}catch(e){alert("Error al conectar con el servidor. Inténtalo de nuevo.")}}));const f=(e,t)=>{const o=document.querySelectorAll(e);if(0===o.length)return;let n;const a=async()=>{if(!document.hidden)try{const e=await fetch(t);if(!e.ok)return void(401!==e.status&&403!==e.status||clearInterval(n));const o=await e.json();r(o.unread_count)}catch(e){console.error(`Error de polling en ${t}:`,e),clearInterval(n)}},r=e=>{o.forEach((t=>{e>0?(t.textContent=e>9?"9+":e,t.style.display="flex"):t.style.display="none"}))};a(),n=setInterval(a,3e3)};f(".dashboard__enlace .message-badge, .navegacion-principal .message-badge","/mensajes/unread-count"),f(".dashboard__enlace .notification-badge, .navegacion-principal .notification-badge","/notificaciones/unread-count"),(()=>{const e=document.querySelectorAll(".mobile-menu .hamburger-badge, .dashboard__mobile-menu .hamburger-badge");if(0===e.length)return;let t;const o=async()=>{if(!document.hidden)try{const[o,n]=await Promise.all([fetch("/mensajes/unread-count"),fetch("/notificaciones/unread-count")]);if(!o.ok||!n.ok)return void(401!==o.status&&403!==o.status&&401!==n.status&&403!==n.status||clearInterval(t));const a=await o.json(),r=await n.json(),i=(a.unread_count||0)+(r.unread_count||0);e.forEach((e=>{i>0?(e.textContent=i>9?"9+":i,e.style.display="flex"):e.style.display="none"}))}catch(e){console.error("Error en el polling combinado:",e),clearInterval(t)}};o(),t=setInterval(o,3e3)})();const m=document.getElementById("marcar-todas-leidas"),A=document.querySelector(".notificaciones-contenedor");if(!A)return;const p=()=>{if(!m)return;const e=document.querySelectorAll(".notificacion-item.no-leida").length;m.style.display=e>0?"inline-flex":"none"};if(m){const g=m.innerHTML;m.addEventListener("click",(async()=>{try{m.disabled=!0,m.textContent="Marcando...";const e=await fetch("/notificaciones/marcar-todas-leidas",{method:"POST"});(await e.json()).success&&(document.querySelectorAll(".notificacion-item.no-leida").forEach((e=>{e.classList.remove("no-leida");const t=e.querySelector(".accion--marcar-leida");t&&(t.className="accion--marcar-no-leida",t.title="Marcar como no leída",t.innerHTML='<i class="fa-solid fa-envelope"></i>')})),f(".notification-badge","/notificaciones/unread-count"))}catch(e){console.error("Error al marcar todas como leídas:",e)}finally{m.disabled=!1,m.innerHTML=g,p()}}))}A&&A.addEventListener("click",(async e=>{const t=e.target.closest(".notificacion-item");if(!t)return;const o=t.dataset.id,n=new FormData;n.append("id",o);const a=e.target.closest(".notificacion-item__enlace"),r=e.target.closest(".accion--marcar-leida"),i=e.target.closest(".accion--marcar-no-leida"),s=e.target.closest(".accion--eliminar");if(a&&(r||i||s)&&e.preventDefault(),a&&!r&&!s){e.preventDefault();const t=a.href,o=new URLSearchParams(new URL(t).search).get("id");if(!o)return void(window.location.href=t);try{const e=await fetch(`/api/producto/estado?id=${o}`),n=await e.json();n.disponible?window.location.href=t:Swal.fire({icon:"info",title:"Aviso",text:n.mensaje||"Este producto ya no está disponible."})}catch(e){console.error("Error al verificar el estado del producto:",e),Swal.fire({icon:"error",title:"Error",text:"No se pudo verificar el producto. Por favor, inténtalo de nuevo más tarde."})}}if(r){e.preventDefault();const o=await fetch("/notificaciones/marcar-leida",{method:"POST",body:n});(await o.json()).success&&(t.classList.remove("no-leida"),r.className="accion--marcar-no-leida",r.title="Marcar como no leída",r.innerHTML='<i class="fa-solid fa-envelope"></i>',f(".notification-badge","/notificaciones/unread-count"),p())}if(i){e.preventDefault();const o=await fetch("/notificaciones/marcar-no-leida",{method:"POST",body:n});(await o.json()).success&&(t.classList.add("no-leida"),i.className="accion--marcar-leida",i.title="Marcar como leída",i.innerHTML='<i class="fa-solid fa-check"></i>',f(".notification-badge","/notificaciones/unread-count"),p())}if(s&&(e.preventDefault(),confirm("¿Estás seguro de que quieres eliminar esta notificación?"))){const e=new FormData;e.append("id",t.dataset.id);try{const o=await fetch("/notificaciones/eliminar",{method:"POST",body:e});(await o.json()).success&&(t.style.transition="opacity 0.3s ease",t.style.opacity="0",setTimeout((()=>{t.remove(),f(".notification-badge","/notificaciones/unread-count"),p()}),300))}catch(e){console.error("Error al eliminar:",e)}}}))})),function(e,t){function o(e,t){return typeof e===t}function n(e){var t=d.className,o=c._config.classPrefix||"";if(u&&(t=t.baseVal),c._config.enableJSClass){var n=new RegExp("(^|\\s)"+o+"no-js(\\s|$)");t=t.replace(n,"$1"+o+"js$2")}c._config.enableClasses&&(t+=" "+o+e.join(" "+o),u?d.className.baseVal=t:d.className=t)}function a(e,t){if("object"==typeof e)for(var o in e)l(e,o)&&a(o,e[o]);else{var r=(e=e.toLowerCase()).split("."),i=c[r[0]];if(2==r.length&&(i=i[r[1]]),void 0!==i)return c;t="function"==typeof t?t():t,1==r.length?c[r[0]]=t:(!c[r[0]]||c[r[0]]instanceof Boolean||(c[r[0]]=new Boolean(c[r[0]])),c[r[0]][r[1]]=t),n([(t&&0!=t?"":"no-")+r.join("-")]),c._trigger(e,t)}return c}var r=[],i=[],s={_version:"3.6.0",_config:{classPrefix:"",enableClasses:!0,enableJSClass:!0,usePrefixes:!0},_q:[],on:function(e,t){var o=this;setTimeout((function(){t(o[e])}),0)},addTest:function(e,t,o){i.push({name:e,fn:t,options:o})},addAsyncTest:function(e){i.push({name:null,fn:e})}},c=function(){};c.prototype=s,c=new c;var l,d=t.documentElement,u="svg"===d.nodeName.toLowerCase();!function(){var e={}.hasOwnProperty;l=o(e,"undefined")||o(e.call,"undefined")?function(e,t){return t in e&&o(e.constructor.prototype[t],"undefined")}:function(t,o){return e.call(t,o)}}(),s._l={},s.on=function(e,t){this._l[e]||(this._l[e]=[]),this._l[e].push(t),c.hasOwnProperty(e)&&setTimeout((function(){c._trigger(e,c[e])}),0)},s._trigger=function(e,t){if(this._l[e]){var o=this._l[e];setTimeout((function(){var e;for(e=0;e<o.length;e++)(0,o[e])(t)}),0),delete this._l[e]}},c._q.push((function(){s.addTest=a})),c.addAsyncTest((function(){function e(e,t,o){function n(t){var n=!(!t||"load"!==t.type)&&1==r.width;a(e,"webp"===e&&n?new Boolean(n):n),o&&o(t)}var r=new Image;r.onerror=n,r.onload=n,r.src=t}var t=[{uri:"data:image/webp;base64,UklGRiQAAABXRUJQVlA4IBgAAAAwAQCdASoBAAEAAwA0JaQAA3AA/vuUAAA=",name:"webp"},{uri:"data:image/webp;base64,UklGRkoAAABXRUJQVlA4WAoAAAAQAAAAAAAAAAAAQUxQSAwAAAABBxAR/Q9ERP8DAABWUDggGAAAADABAJ0BKgEAAQADADQlpAADcAD++/1QAA==",name:"webp.alpha"},{uri:"data:image/webp;base64,UklGRlIAAABXRUJQVlA4WAoAAAASAAAAAAAAAAAAQU5JTQYAAAD/////AABBTk1GJgAAAAAAAAAAAAAAAAAAAGQAAABWUDhMDQAAAC8AAAAQBxAREYiI/gcA",name:"webp.animation"},{uri:"data:image/webp;base64,UklGRh4AAABXRUJQVlA4TBEAAAAvAAAAAAfQ//73v/+BiOh/AAA=",name:"webp.lossless"}],o=t.shift();e(o.name,o.uri,(function(o){if(o&&"load"===o.type)for(var n=0;n<t.length;n++)e(t[n].name,t[n].uri)}))})),function(){var e,t,n,a,s,l;for(var d in i)if(i.hasOwnProperty(d)){if(e=[],(t=i[d]).name&&(e.push(t.name.toLowerCase()),t.options&&t.options.aliases&&t.options.aliases.length))for(n=0;n<t.options.aliases.length;n++)e.push(t.options.aliases[n].toLowerCase());for(a=o(t.fn,"function")?t.fn():t.fn,s=0;s<e.length;s++)1===(l=e[s].split(".")).length?c[l[0]]=a:(!c[l[0]]||c[l[0]]instanceof Boolean||(c[l[0]]=new Boolean(c[l[0]])),c[l[0]][l[1]]=a),r.push((a?"":"no-")+l.join("-"))}}(),n(r),delete s.addTest,delete s.addAsyncTest;for(var f=0;f<c._q.length;f++)c._q[f]();e.Modernizr=c}(window,document);