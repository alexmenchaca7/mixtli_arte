document.addEventListener("DOMContentLoaded",(()=>{function e(e,t="info"){const o=document.querySelector(".alert-notification");o&&o.remove();const n=document.createElement("div");switch(n.className="alert-notification",n.innerHTML=e,t){case"success":n.style.backgroundColor="#4CAF50";break;case"error":n.style.backgroundColor="#f44336";break;default:n.style.backgroundColor="#2196F3"}document.body.appendChild(n),setTimeout((()=>{n.style.opacity="0",setTimeout((()=>n.remove()),300)}),3e3)}const t=document.getElementById("categorias-btn"),o=document.getElementById("categorias-modal"),n=document.querySelector(".close");if(t&&o&&n){function a(){document.body.style.overflow=""}o.classList.remove("show"),t.addEventListener("click",(()=>{o.classList.add("show"),document.body.style.overflow="hidden"})),n.addEventListener("click",(()=>{o.classList.remove("show"),a()})),window.addEventListener("click",(e=>{e.target===o&&(o.classList.remove("show"),a())}))}const r=document.querySelector(".dropdown");if(r){r.querySelector(".dropdown__boton").addEventListener("click",(e=>{e.stopPropagation(),r.classList.toggle("mostrar")})),window.addEventListener("click",(e=>{r.contains(e.target)||r.classList.remove("mostrar")}))}const i=document.querySelectorAll(".contador");if(i.length>0){const g=e=>{const t=parseInt(e.dataset.target,10);let o=0;const n=t/31.25,a=()=>{o+=n,o>=t?e.innerText=`+${t}`:(e.innerText=`+${Math.floor(o)}`,requestAnimationFrame(a))};a()},h=new IntersectionObserver((e=>{e.forEach((e=>{e.isIntersecting&&(e.target.classList.remove("animado"),e.target.innerText="+0",g(e.target))}))}),{threshold:.3});i.forEach((e=>h.observe(e))),window.addEventListener("load",(()=>{i.forEach((e=>{e.classList.contains("animado")||g(e)}))}))}const s=document.querySelector(".dashboard__mobile-menu"),c=document.querySelector(".dashboard__sidebar");s&&c&&(s.addEventListener("click",(function(){c.classList.toggle("sidebar--mostrar")})),document.body.addEventListener("click",(function(e){c.contains(e.target)||s.contains(e.target)||c.classList.remove("sidebar--mostrar")}))),document.querySelectorAll(".favorito-btn").forEach((t=>{t.addEventListener("click",(async o=>{if(o.preventDefault(),this.disabled)return;const n=t.dataset.productoId,a=t.querySelector("i");try{const t=await fetch("/favoritos/toggle",{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},body:`productoId=${encodeURIComponent(n)}`}),o=await t.json();if(!t.ok)throw new Error(o.error||"Error en la solicitud");a.classList.toggle("fa-regular"),a.classList.toggle("fa-solid");const r=document.querySelector(".alert-notification");r&&r.remove();e("added"===o.action?'<i class="fas fa-check-circle"></i> Agregado a favoritos':'<i class="fas fa-trash-alt"></i> Eliminado de favoritos',"added"===o.action?"success":"error")}catch(t){console.error("Error:",t),e(t.message,"error")}}))})),document.body.addEventListener("click",(async function(t){if(t.target.closest(".no-interesa-btn")){const o=t.target.closest(".no-interesa-btn"),n=o.dataset.productoId;try{const t=await fetch("/api/productos/no-interesa",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({productoId:n})}),a=await t.json();if(a.success){const t=o.closest('.producto[data-producto-card-id="'+n+'"]');t&&(t.style.transition="opacity 0.5s ease",t.style.opacity="0",setTimeout((()=>t.remove()),500)),e('<i class="fas fa-check-circle"></i> No volveremos a mostrarte este producto.',"info")}else alert("Error: "+a.error)}catch(e){console.error("Error:",e),alert("No se pudo completar la acción.")}}})),document.addEventListener("click",(async e=>{if(e.target.classList.contains("btn-eliminar-preferencia")){const t=e.target,o=t.closest(".item-no-interesado"),n=o.dataset.productoId;if(t.disabled)return;t.disabled=!0,t.textContent="Eliminando...";try{const e=await fetch("/perfil/eliminar-no-interesa",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({productoId:n})}),t=await e.json();if(!e.ok||!t.success)throw new Error(t.error||"Error desconocido del servidor.");o.style.transition="opacity 0.3s ease",o.style.opacity="0",setTimeout((()=>o.remove()),300)}catch(e){console.error("Error al procesar la solicitud:",e),alert(e.message),t.disabled=!1,t.textContent="Eliminar"}}}));const l=document.getElementById("modal-reporte-valoracion");if(!l)return;const d=document.getElementById("form-reporte-valoracion"),u=l.querySelector(".modal-reporte__cerrar"),f=document.getElementById("reporte-valoracion-id");document.body.addEventListener("click",(function(e){if(e.target.closest(".reportar-btn")){const t=e.target.closest(".reportar-btn").dataset.valoracionId;f.value=t,l.style.display="flex"}})),u.onclick=()=>{l.style.display="none"},window.onclick=e=>{e.target===l&&(l.style.display="none")},d.addEventListener("submit",(async function(e){e.preventDefault();const t=new FormData(this),o=Object.fromEntries(t.entries());try{const e=await fetch("/valoraciones/reportar",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(o)}),t=await e.json();alert(t.message||t.error),e.ok&&(l.style.display="none",d.reset())}catch(e){alert("Error al conectar con el servidor. Inténtalo de nuevo.")}}));const m=(e,t)=>{const o=document.querySelectorAll(e);if(0===o.length)return;let n;const a=async()=>{if(!document.hidden)try{const e=await fetch(t);if(!e.ok)return void(401!==e.status&&403!==e.status||clearInterval(n));const o=await e.json();r(o.unread_count)}catch(e){console.error(`Error de polling en ${t}:`,e),clearInterval(n)}},r=e=>{o.forEach((t=>{e>0?(t.textContent=e>9?"9+":e,t.style.display="flex"):t.style.display="none"}))};a(),n=setInterval(a,3e3)};m(".dashboard__enlace .message-badge, .navegacion-principal .message-badge","/mensajes/unread-count"),m(".dashboard__enlace .notification-badge, .navegacion-principal .notification-badge","/notificaciones/unread-count"),(()=>{const e=document.querySelectorAll(".mobile-menu .hamburger-badge, .dashboard__mobile-menu .hamburger-badge");if(0===e.length)return;let t;const o=async()=>{if(!document.hidden)try{const[o,n]=await Promise.all([fetch("/mensajes/unread-count"),fetch("/notificaciones/unread-count")]);if(!o.ok||!n.ok)return void(401!==o.status&&403!==o.status&&401!==n.status&&403!==n.status||clearInterval(t));const a=await o.json(),r=await n.json(),i=(a.unread_count||0)+(r.unread_count||0);e.forEach((e=>{i>0?(e.textContent=i>9?"9+":i,e.style.display="flex"):e.style.display="none"}))}catch(e){console.error("Error en el polling combinado:",e),clearInterval(t)}};o(),t=setInterval(o,3e3)})();const A=document.getElementById("marcar-todas-leidas"),p=document.querySelector(".notificaciones-contenedor");if(!p)return;const y=()=>{if(!A)return;const e=document.querySelectorAll(".notificacion-item.no-leida").length;A.style.display=e>0?"inline-flex":"none"};if(A){const v=A.innerHTML;A.addEventListener("click",(async()=>{try{A.disabled=!0,A.textContent="Marcando...";const e=await fetch("/notificaciones/marcar-todas-leidas",{method:"POST"});(await e.json()).success&&(document.querySelectorAll(".notificacion-item.no-leida").forEach((e=>{e.classList.remove("no-leida");const t=e.querySelector(".accion--marcar-leida");t&&(t.className="accion--marcar-no-leida",t.title="Marcar como no leída",t.innerHTML='<i class="fa-solid fa-envelope"></i>')})),m(".notification-badge","/notificaciones/unread-count"))}catch(e){console.error("Error al marcar todas como leídas:",e)}finally{A.disabled=!1,A.innerHTML=v,y()}}))}p&&p.addEventListener("click",(async t=>{const o=t.target.closest(".notificacion-item");if(!o)return;const n=o.dataset.id,a=new FormData;a.append("id",n);const r=t.target.closest(".notificacion-item__enlace"),i=t.target.closest(".accion--marcar-leida"),s=t.target.closest(".accion--marcar-no-leida"),c=t.target.closest(".accion--eliminar");if(r&&(i||s||c)&&t.preventDefault(),r&&!i&&!c){t.preventDefault();const o=r.href,n=new URLSearchParams(new URL(o).search).get("id");if(!n)return void(window.location.href=o);try{const t=await fetch(`/api/producto/estado?id=${n}`),a=await t.json();a.disponible?window.location.href=o:e(a.mensaje,"error")}catch(e){console.error("Error al verificar el estado del producto:",e)}}if(i){t.preventDefault();const e=await fetch("/notificaciones/marcar-leida",{method:"POST",body:a});(await e.json()).success&&(o.classList.remove("no-leida"),i.className="accion--marcar-no-leida",i.title="Marcar como no leída",i.innerHTML='<i class="fa-solid fa-envelope"></i>',m(".notification-badge","/notificaciones/unread-count"),y())}if(s){t.preventDefault();const e=await fetch("/notificaciones/marcar-no-leida",{method:"POST",body:a});(await e.json()).success&&(o.classList.add("no-leida"),s.className="accion--marcar-leida",s.title="Marcar como leída",s.innerHTML='<i class="fa-solid fa-check"></i>',m(".notification-badge","/notificaciones/unread-count"),y())}if(c&&(t.preventDefault(),confirm("¿Estás seguro de que quieres eliminar esta notificación?"))){const e=new FormData;e.append("id",o.dataset.id);try{const t=await fetch("/notificaciones/eliminar",{method:"POST",body:e});(await t.json()).success&&(o.style.transition="opacity 0.3s ease",o.style.opacity="0",setTimeout((()=>{o.remove(),m(".notification-badge","/notificaciones/unread-count"),y()}),300))}catch(e){console.error("Error al eliminar:",e)}}}))})),function(e,t){function o(e,t){return typeof e===t}function n(e){var t=d.className,o=c._config.classPrefix||"";if(u&&(t=t.baseVal),c._config.enableJSClass){var n=new RegExp("(^|\\s)"+o+"no-js(\\s|$)");t=t.replace(n,"$1"+o+"js$2")}c._config.enableClasses&&(t+=" "+o+e.join(" "+o),u?d.className.baseVal=t:d.className=t)}function a(e,t){if("object"==typeof e)for(var o in e)l(e,o)&&a(o,e[o]);else{var r=(e=e.toLowerCase()).split("."),i=c[r[0]];if(2==r.length&&(i=i[r[1]]),void 0!==i)return c;t="function"==typeof t?t():t,1==r.length?c[r[0]]=t:(!c[r[0]]||c[r[0]]instanceof Boolean||(c[r[0]]=new Boolean(c[r[0]])),c[r[0]][r[1]]=t),n([(t&&0!=t?"":"no-")+r.join("-")]),c._trigger(e,t)}return c}var r=[],i=[],s={_version:"3.6.0",_config:{classPrefix:"",enableClasses:!0,enableJSClass:!0,usePrefixes:!0},_q:[],on:function(e,t){var o=this;setTimeout((function(){t(o[e])}),0)},addTest:function(e,t,o){i.push({name:e,fn:t,options:o})},addAsyncTest:function(e){i.push({name:null,fn:e})}},c=function(){};c.prototype=s,c=new c;var l,d=t.documentElement,u="svg"===d.nodeName.toLowerCase();!function(){var e={}.hasOwnProperty;l=o(e,"undefined")||o(e.call,"undefined")?function(e,t){return t in e&&o(e.constructor.prototype[t],"undefined")}:function(t,o){return e.call(t,o)}}(),s._l={},s.on=function(e,t){this._l[e]||(this._l[e]=[]),this._l[e].push(t),c.hasOwnProperty(e)&&setTimeout((function(){c._trigger(e,c[e])}),0)},s._trigger=function(e,t){if(this._l[e]){var o=this._l[e];setTimeout((function(){var e;for(e=0;e<o.length;e++)(0,o[e])(t)}),0),delete this._l[e]}},c._q.push((function(){s.addTest=a})),c.addAsyncTest((function(){function e(e,t,o){function n(t){var n=!(!t||"load"!==t.type)&&1==r.width;a(e,"webp"===e&&n?new Boolean(n):n),o&&o(t)}var r=new Image;r.onerror=n,r.onload=n,r.src=t}var t=[{uri:"data:image/webp;base64,UklGRiQAAABXRUJQVlA4IBgAAAAwAQCdASoBAAEAAwA0JaQAA3AA/vuUAAA=",name:"webp"},{uri:"data:image/webp;base64,UklGRkoAAABXRUJQVlA4WAoAAAAQAAAAAAAAAAAAQUxQSAwAAAABBxAR/Q9ERP8DAABWUDggGAAAADABAJ0BKgEAAQADADQlpAADcAD++/1QAA==",name:"webp.alpha"},{uri:"data:image/webp;base64,UklGRlIAAABXRUJQVlA4WAoAAAASAAAAAAAAAAAAQU5JTQYAAAD/////AABBTk1GJgAAAAAAAAAAAAAAAAAAAGQAAABWUDhMDQAAAC8AAAAQBxAREYiI/gcA",name:"webp.animation"},{uri:"data:image/webp;base64,UklGRh4AAABXRUJQVlA4TBEAAAAvAAAAAAfQ//73v/+BiOh/AAA=",name:"webp.lossless"}],o=t.shift();e(o.name,o.uri,(function(o){if(o&&"load"===o.type)for(var n=0;n<t.length;n++)e(t[n].name,t[n].uri)}))})),function(){var e,t,n,a,s,l;for(var d in i)if(i.hasOwnProperty(d)){if(e=[],(t=i[d]).name&&(e.push(t.name.toLowerCase()),t.options&&t.options.aliases&&t.options.aliases.length))for(n=0;n<t.options.aliases.length;n++)e.push(t.options.aliases[n].toLowerCase());for(a=o(t.fn,"function")?t.fn():t.fn,s=0;s<e.length;s++)1===(l=e[s].split(".")).length?c[l[0]]=a:(!c[l[0]]||c[l[0]]instanceof Boolean||(c[l[0]]=new Boolean(c[l[0]])),c[l[0]][l[1]]=a),r.push((a?"":"no-")+l.join("-"))}}(),n(r),delete s.addTest,delete s.addAsyncTest;for(var f=0;f<c._q.length;f++)c._q[f]();e.Modernizr=c}(window,document);